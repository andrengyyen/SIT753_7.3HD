<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script
      src="https://kit.fontawesome.com/e035f1a289.js"
      crossorigin="anonymous"
    ></script>
    
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <!--menu-->
    <section id="header">
      <a href="index.html"><img src="img/logo.png" class="logo" alt="" /></a>
      <div>
        <ul id="navbar">
          <li><a href="index.html">Home</a></li>
          <li><a href="shop.html">Shop</a></li>
          <li><a href="news.html">News</a></li>
          <li><a href="contact.html">Contact</a></li>
          <li><a href="about.html">About</a></li>
          <li id="lg-bag">
            <a class="active" href="cart.html"> <i class="fa-solid fa-bag-shopping"><span id="numItemInCart" style="color:red; font-size: 0.8em; font-weight: bold;"></span></i></a>
          </li>
          <li id="helloMessage"><span >Hello Guest</span></li>
          <li id="login-button"><a style="color: blue;" href="login.html">Login</a></li>
          <a href="#" id="close"><i class="fa-solid fa-xmark"></i></a>
        </ul>
      </div>
      <div id="mobile">
        <a href="cart.html"><i class="fa-solid fa-bag-shopping"></i></a>
        <span id="numItemInCart1" style="color:red; font-size: 1em; font-weight: bold;"></span>
        <i id="bar" class="fas fa-outdent"></i>
      </div>
    </section>

    <!--#checkout-->
    <section id="page-header" class="about-header">
      <h1>#CheckOut</h1>
      <p>Thank you</p>
    </section>

    <!--Cart table-->
    <section id="cart" class="section-p1">
      <table width="100%">
        <thead>
          <tr>
            <td>Remove</td>
            <td>Image</td>
            <td>Product</td>
            <td>Size</td> 
            <td>Price</td>
            <td>Quantity</td>
            <td>Subtotal</td>
          </tr>
        </thead>
        <tbody id="cartBody">
          <!-- <tr>
            <td>
              <a href="#"><i class="fa-solid fa-circle-xmark"></i></a>
            </td>
            <td><img src="img/products/f1.jpg" alt="" /></td>
            <td>Basic Shirt(S)</td>
            <td>$78</td>
            <td><input type="number" value="1" /></td>
            <td>$78</td>
          </tr>
          <tr>
            <td>
              <a href="#"><i class="fa-solid fa-circle-xmark"></i></a>
            </td>
            <td><img src="img/products/f2.jpg" alt="" /></td>
            <td>Soft Man(M)</td>
            <td>$78</td>
            <td><input type="number" value="1" /></td>
            <td>$78</td>
          </tr>
          <tr>
            <td>
              <a href="#"><i class="fa-solid fa-circle-xmark"></i></a>
            </td>
            <td><img src="img/products/f3.jpg" alt="" /></td>
            <td>Flower Shirt(L)</td>
            <td>$78</td>
            <td><input type="number" value="1" /></td>
            <td>$78</td>
          </tr> -->
        </tbody>
      </table>
    </section>

    <!--Adding coupon and Cart total table-->
    <section id="cart-add" class="section-p1">
      <div id="coupon">
        <h1>Apply Coupon</h1>
        <div>
          <input type="text" placeholder="Enter Your Coupon" />
          <button class="normal">Apply</button>
        </div>
      </div>

      <div id="subtotal">
        <h1>Cart Totals</h1>
        <form method="post" action="/checkout">
          <table>
          </table>
          <button type="submit" class="normal">Checkout</button>
        </form>
        
      </div>
    </section>

    <!--sign up-->
    <section id="newsletters" class="section-p1 section-m1">
      <div class="newstext">
        <h1>Sign Up For News & Promotion</h1>
        <p>
          Get E-mail updates about our shop and <span>special offers</span>.
        </p>
      </div>
      <div class="form">
        <input type="text" placeholder="Your Email" />
        <button class="normal" style="padding-bottom: 10px;">Sign Up</button>
      </div>
    </section>

    <!--footer-->
    <footer class="section-p1">
      <div class="col">
        <img class="logo" src="img/logo.png" alt="" />
        <h4><strong>Contact</strong></h4>
        <p>
          <strong>Address: </strong>Deakin University Burwood Campus, Australia
        </p>
        <p><strong>Phone: </strong>0123456789</p>
        <p><strong>Working time: </strong>10:00 - 18:00, Mon-Sat</p>
        <div class="follow">
          <h4><strong>Follow us</strong></h4>
          <div class="icon">
            <i class="fab fa-facebook"></i>
            <i class="fab fa-twitter"></i>
            <i class="fab fa-instagram"></i>
            <i class="fab fa-pinterest-p"></i>
            <i class="fab fa-youtube"></i>
          </div>
        </div>
      </div>

      <div class="col">
        <h4><strong>About</strong></h4>
        <a href="#">About us</a>
        <a href="#">Delivery Information</a>
        <a href="#">Policy</a>
        <a href="#">Terms & Conditions</a>
        <a href="#">Contact</a>
      </div>

      <div class="col">
        <h4><strong>Account</strong> </h4>
        <a href="#">Sign in</a>
        <a href="#">Cart</a>
        <a href="#">My Wishlist</a>
        <a href="#">Orders</a>
        <a href="#">Help</a>
      </div>

      <div class="col install">
        <h4><strong>Install App</strong></h4>
        <p>From App Store or Google Play</p>
        <div>
          <img src="img/pay/app.jpg" alt="" />
          <img src="img/pay/play.jpg" alt="" />
        </div>
        <p>Secured Payment Gateways</p>
        <img src="img/pay/pay.png" alt="" />
      </div>

      <div class="copyright">
        <p><strong> Â©2024 SIT774 ASS. ALL RIGHTS RESERVED.</strong></p>
      </div>
    </footer>

    <!--navigation bar on the mobile screen-->
    <script src="js/script.js"></script>
    
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Fetch the cart items from the server when the page loads
        fetch('/getCart')
            .then(response => response.json())
            .then(cart => renderCartItems(cart))
            .catch(error => console.error('Error fetching cart items:', error));

        fetch('/getCartLength')
            .then(response => response.json())
            .then(cartLength => {
                document.getElementById("numItemInCart").innerText = " " + cartLength;
                document.getElementById("numItemInCart1").innerText = " " + cartLength;
            });

        // Check if the user is logged in
        const currentUser = localStorage.getItem('currentUser');
        const checkoutButton = document.querySelector('#subtotal button[type="submit"]');
        const loginButton = document.getElementById('login-button');
        const helloMessage = document.getElementById('helloMessage');

        if (currentUser) {
            // User is logged in, update the login button to Log Out and display greeting
            loginButton.innerHTML = `<a style="color: blue;" href="#" id="logout-button">Log Out</a>`;
            helloMessage.innerHTML = `<span>Hello <strong>${currentUser}</strong></span>`;
            helloMessage.style.fontSize = "20px";

            // Add event listener for logout
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.removeItem('currentUser');
                window.location.reload();
            });
        } else {
            // User is not logged in, disable checkout button and prompt to log in
            checkoutButton.disabled = true;
            checkoutButton.innerText = 'Log in to Checkout';
            checkoutButton.style.backgroundColor = 'red';

            checkoutButton.addEventListener('click', (event) => {
                event.preventDefault();
                alert('Please log in before checking out.');
                // Redirect to login page
                window.location.href = 'login.html';
            });
        }
    });
      
      
      // Function to render cart items
      // Function to render cart items
      function renderCartItems(cart) {
          const cartBody = document.getElementById('cartBody');
          cartBody.innerHTML = '';  // Clear any existing cart content

          let cartTotal = 0;

          // Loop through each item in the cart and create a table row for each item
          cart.forEach((item, index) => {
              const itemPrice = parseFloat(item.price.replace('$', ''));  // Convert price string to a float
              const itemSubtotal = itemPrice * item.quantity;
              cartTotal += itemSubtotal;  // Add to cart total

              // Create a row for each cart item
              const row = document.createElement('tr');
              row.innerHTML = `
                  <td><a href="#" data-index="${index}" class="remove-item"><i class="fa-solid fa-circle-xmark"></i></a></td>
                  <td><img src="${item.image}" alt="${item.name}" /></td>
                  <td>${item.name}</td>
                  <td>
                      <select class="size-select" data-index="${index}">
                          <option value="XS" ${item.size === 'XS' ? 'selected' : ''}>XS</option>
                          <option value="S" ${item.size === 'S' ? 'selected' : ''}>S</option>
                          <option value="M" ${item.size === 'M' ? 'selected' : ''}>M</option>
                          <option value="L" ${item.size === 'L' ? 'selected' : ''}>L</option>
                          <option value="XL" ${item.size === 'XL' ? 'selected' : ''}>XL</option>
                          <option value="XXL" ${item.size === 'XXL' ? 'selected' : ''}>XXL</option>
                      </select>
                  </td>
                  <td>${item.price}</td>
                  <td><input type="number" value="${item.quantity}" min="1" class="quantity-input" data-index="${index}" /></td>
                  <td class="subtotal">$${itemSubtotal.toFixed(2)}</td>
              `;
              cartBody.appendChild(row);  // Append the row to the table body
          });

          // Render the cart total in the summary section
          updateCartTotal(cartTotal);

          // Add event listeners to the remove buttons
          document.querySelectorAll('.remove-item').forEach(button => {
              button.addEventListener('click', (event) => {
                  event.preventDefault();
                  const index = button.getAttribute('data-index');
                  removeFromCart(index);
              });
          });

          // Add event listeners to the quantity inputs
          document.querySelectorAll('.quantity-input').forEach(input => {
              input.addEventListener('change', (event) => {
                  const index = input.getAttribute('data-index');
                  const newQuantity = parseInt(input.value);
                  if (newQuantity > 0) {
                      updateCartQuantity(index, newQuantity);
                  }
              });
          });

          // Add event listeners to the size dropdowns
          document.querySelectorAll('.size-select').forEach(select => {
              select.addEventListener('change', (event) => {
                  const index = select.getAttribute('data-index');
                  const selectedSize = select.value;
                  console.log(`Size for item at index ${index} changed to ${selectedSize}`);
                  updateItemSize(index, selectedSize);
              });
          });
      }
      
      // Function to update cart total in the summary section
      function updateCartTotal(cartTotal) {
          document.querySelector('#subtotal table').innerHTML = `
              <tr>
                  <td>Cart Subtotal</td>
                  <td>$${cartTotal.toFixed(2)}</td>
              </tr>
              <tr>
                  <td>Shipping</td>
                  <td>Free</td>
              </tr>
              <tr>
                  <td><strong>Total</strong></td>
                  <td><strong>$${cartTotal.toFixed(2)}</strong></td>
              </tr>
          `;
      }
      
      // Function to remove an item from the cart
      function removeFromCart(index) {
          fetch('/removeFromCart', {
              method: 'POST',
              headers: {
                  "Content-type": "application/json; charset=UTF-8"
              },
              body: JSON.stringify({ index: parseInt(index) })  // Send the correct product index to the server
          })
          .then(response => response.json())
          .then(data => {
              alert(data.message);
              renderCartItems(data.cart);  // Re-render the cart with the updated data
              document.getElementById("numItemInCart").innerText = " " + data.cart.length;
              document.getElementById("numItemInCart1").innerText = " " + data.cart.length;
          })
          .catch(error => console.error('Error removing item from cart:', error));
      }
      
      // Function to update cart quantity
      function updateCartQuantity(index, newQuantity) {
          fetch('/updateCartQuantity', {
              method: 'POST',
              headers: {
                  "Content-type": "application/json; charset=UTF-8"
              },
              body: JSON.stringify({ index: parseInt(index), quantity: newQuantity })  // Send updated quantity to server
          })
          .then(response => response.json())
          .then(data => {
              console.log(data.message);
              renderCartItems(data.cart);  // Re-render the cart with the updated data
          })
          .catch(error => console.error('Error updating item quantity:', error));
      }

        // Function to update item size in the cart
        function updateItemSize(index, newSize) {
            fetch('/updateItemSize', {
                method: 'POST',
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                },
                body: JSON.stringify({ index: parseInt(index), size: newSize })  // Send updated size to server
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
                renderCartItems(data.cart);  // Re-render the cart with the updated data
            })
            .catch(error => console.error('Error updating item size:', error));
        }
      </script>
      
      
        
    <!-- <script src="js/addToCart.js"></script> -->
  </body>
</html>
